<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>MoonGen: Packet API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">MoonGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="download.html"><span>Download</span></a></li>
      <li><a href="documentation.html"><span>Documentation</span></a></li>
      <li><a href="files.html"><span>Filebrowser</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('packet_api.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Packet API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#rte_mbuf">rte_mbuf</a></li>
<li class="level1"><a href="#packet_wrappers">Dynamic creation of wrappers for c-structs of different packet types</a><ul><li class="level2"><a href="#pw_overview">Overview</a></li>
<li class="level2"><a href="#pw_members">Functions on Members</a></li>
<li class="level2"><a href="#pw_headers">Functions on Headers</a></li>
<li class="level2"><a href="#pw_packets">Functions on Packets</a></li>
</ul>
</li>
<li class="level1"><a href="#create_packet_wrappers">Create new packet types</a><ul><li class="level2"><a href="#pw_summary">Summary</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>The DPDK provides one main data struct to work with packets: rte_mbuf. MoonGen provides further wrappers, offering enhanced and easy-to-use functions while maintaining critical performance.</p>
<h1><a class="anchor" id="rte_mbuf"></a>
rte_mbuf</h1>
<p>TBD: Mainly internal struct. Provides some fields to store meta data. Otherwise the actual packet is only bytes.</p>
<h1><a class="anchor" id="packet_wrappers"></a>
Dynamic creation of wrappers for c-structs of different packet types</h1>
<p>Lua wrapper for the actual packet data. The data can be casted to different kinds of packets that get created dynamically.</p>
<h2><a class="anchor" id="pw_overview"></a>
Overview</h2>
<p>As working with raw bytes isn't productive, MoonGen provides the ability to cast a 'struct rte_mbuf' to different kinds of packets. The hereby used c struct is dynamically created, depending on the used cast function. The members of the struct are the different headers of the used packet type (for instance an ethernet header, followed by an IPv4 header, ..., followed by payload). The headers themselves are implemented in <a class="el" href="headers_8lua.html">headers.lua</a> . The respective lua wrapper module of each header can be found in the proto/ folder. These provide the functions on the header and its members. The functions on packets are dynamically created so they don't have to be reimplemented for each, only minorly differing packettype. They are explained in section <a class="el" href="packet_api.html#pw_packets">Functions on Packets</a> .</p>
<h2><a class="anchor" id="pw_members"></a>
Functions on Members</h2>
<p>The functions for each member of a protocols header are defined in the respective file in the proto/ subfolder. For each member the following functions are implemented:</p>
<ul>
<li>set(value) <br/>
 Set the member (the bytes of that member) to 'value'. Takes care of correct byte order. If no value is provided a reasonable default value is used instead.</li>
<li>get() <br/>
 Returns the value of the member. Refer to the documentation to find out the actual data type of the value (number, cdata, ...).</li>
<li><a class="el" href="arp_8lua.html#a0c54aeefe661a546eb4adc30d8b311ef" title="Retrieve the values of all members. ">getString()</a> <br/>
 Returns a string representation of that value.</li>
</ul>
<p>Refer to the filebrowser for a complete list of available functions and their documentation.</p>
<h2><a class="anchor" id="pw_headers"></a>
Functions on Headers</h2>
<p>In addition to the above, the following functions are implemented for the header itself:</p>
<ul>
<li>fill(namedArgs, prefix) <br/>
 Invokes the set function of each member of this header. namedArgs is a table containing the values that should be passed to each separate <a class="el" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e" title="Set the MAC address. ">set()</a> function, identified via the respective named argument prepended with the prefix. For instance if the header of a packet (so this packets member) is called 'ip4' and one wants to set the protocol field and version. <div class="fragment"><div class="line">:<a class="code" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4">fill</a>({ <span class="stringliteral">&#39;ip4Protocol&#39;</span>=13, <span class="stringliteral">&#39;ip4Version&#39;</span>=1 }, <span class="stringliteral">&#39;ip4&#39;</span>)</div>
</div><!-- fragment --> All arguments starting with the prefix 'ip4' will be passed to the respective <a class="el" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e" title="Set the MAC address. ">set()</a> function, all other <a class="el" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e" title="Set the MAC address. ">set()</a> functions are called without parameter, hence the default value is set. For the list of available arguments see the respective <a class="el" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4" title="Set all members of the ip header. ">fill()</a> method.</li>
<li>get(prefix) <br/>
 Invokes the get function of each member of this header and returns all of their value as table, using the a table of the same named arguments as above, prepended with the specified prefix.</li>
<li><a class="el" href="arp_8lua.html#a0c54aeefe661a546eb4adc30d8b311ef" title="Retrieve the values of all members. ">getString()</a> <br/>
 Returns a string that is build by invoking the getString function of each member and concatinating the results. This is mainly used to dump the header.</li>
</ul>
<p>Note that the set and get function are slow as they use lua tables. Do not use them in time critical parts of your code. Normally you would only use them to prefill a mempool.</p>
<p>Furthermore, there are two functions for each header that are only used internally.</p>
<h2><a class="anchor" id="pw_packets"></a>
Functions on Packets</h2>
<ul>
<li>fill(namedArgs) <br/>
 Invokes <a class="el" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4" title="Set all members of the ip header. ">fill()</a> for each header (using the correct prefix) and passes the specified table of named arguments. This function always provides "intelligent" default values for named arguments that are not specified. For instance the etherType of an IP4 packet will always be set to the value of IP4, while for an IP6 packet it will be set to the etherType of IP6 (unless the table contains an entry '&lt;prefix&gt;Type', then this will always be used instead).</li>
<li>get() <br/>
 Invokes get() on each header and returns one resulting table.</li>
<li><a class="el" href="packet_8lua.html#a2635156d751e509e4b4f607a2b045c5a" title="Dumps the packet data cast to the best fitting packet struct. ">dump(bytes)</a> <br/>
 Prints a tcpdump-like dump of the packet including full cleartext of the headers. Either dumps the specified number of bytes or estimated from the length of the packet struct.</li>
<li>setLength(len) <br/>
 Set the length value of each header (it it has one) depending on the packet length and the position of the header in the packet (basically by accumulating the length of headers before this header).</li>
<li>calculateChecksums() <br/>
 Calculate all checksums of all headers (that have a checksum field) in software. Has significant impact on the performance. If possible, use checksum-offloading.</li>
<li>calculateChecksumXYZ() <br/>
 For each header XYZ of the packet that has a checksum member a function to calculate it in software is provided (e.g. calculateChecksumIcmp). Has significant impact on the performance. If possible, use checksum-offloading.</li>
</ul>
<h1><a class="anchor" id="create_packet_wrappers"></a>
Create new packet types</h1>
<p>The function <a class="el" href="packet_8lua.html#a9ec741ec046b38ff23624e841a2ec3da" title="Create struct and functions for a new packet. ">packetCreate()</a> of the <a class="el" href="packet_8lua.html" title="Utility functions for packets (rte_mbuf). ">packet.lua</a> module can be used to create a new user-defined packet type. The user only has to provide the protocols in the order they should appear in the packet. It then automatically creates the respective c struct, consisting of the names headers. The last member is always payload. Furthermore, it automatcally creates the functions mentioned in <a class="el" href="packet_api.html#pw_packets">Functions on Packets</a> for this kind of packet. <a class="el" href="packet_8lua.html#a9ec741ec046b38ff23624e841a2ec3da" title="Create struct and functions for a new packet. ">packetCreate()</a> returns the cast function for the created packet type.</p>
<p>Per default, the member of the packet for each protocol will be named after the protocol (protocol: ip4, member: ip4). The member can manually be renamed by specifying the name of the protocol, followed by the name of the member in a list, e.g. { 'ip4', 'innerIP'}. Available protocols: eth (ethernet), ip4, ip6, udp, tcp, arp, icmp, ptp.</p>
<p>Example: </p>
<div class="fragment"><div class="line">local myPacketType = <a class="code" href="packet_8lua.html#a9ec741ec046b38ff23624e841a2ec3da">packetCreate</a>(<span class="stringliteral">&#39;eth&#39;</span>, <span class="stringliteral">&#39;ip4&#39;</span>, { <span class="stringliteral">&#39;eth&#39;</span>, <span class="stringliteral">&#39;secondEth&#39;</span> })</div>
</div><!-- fragment --><p> The created c struct will look as follows: </p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ethernet_header <a class="code" href="ethernet_8lua.html#abd4d16011dee203ba12fc0b0cb1df914">eth</a>;</div>
<div class="line"><span class="keyword">struct </span>ip4_header ip4;</div>
<div class="line"><span class="keyword">struct </span>ethernet_header secondEth;</div>
<div class="line"><span class="keyword">union </span>payload_t payload;</div>
</div><!-- fragment --><h2><a class="anchor" id="pw_summary"></a>
Summary</h2>
<p>Aside from the existing types of packets (listed in the 'Packets' section of each respective protocol module) a user can at any time define further, custom packets. MoonGen then automatically provides functions to work on the packet, on each header of that packet and on each member of such a header.</p>
<div class="fragment"><div class="line">buf = buf:<a class="code" href="udp_8lua.html#adaa53b02964eaa0ac8d46b96eceeabbe">getUdpPacket</a>()</div>
<div class="line"></div>
<div class="line">buf.<a class="code" href="udp_8lua.html#a605be069667aac4e9674572dee46d278">udp</a>.src = hton(1234)     -- case 1</div>
<div class="line">buf.<a class="code" href="udp_8lua.html#a605be069667aac4e9674572dee46d278">udp</a>:<a class="code" href="tcp_8lua.html#a15b5825ba42f81e0560ffe1bfeab7627">setSrcPort</a>(1234)     -- case 2</div>
<div class="line">buf.<a class="code" href="udp_8lua.html#a605be069667aac4e9674572dee46d278">udp</a>:<a class="code" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4">fill</a>{ udpSrc=1234 }  -- <span class="keywordflow">case</span> 3</div>
<div class="line">buf:<a class="code" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4">fill</a>{ udpSrc=1234 }      -- <span class="keywordflow">case</span> 4</div>
</div><!-- fragment --><p>All of the four cases result in the same 16 bits of the data set accordingly. However, there are slight differences:</p>
<ul>
<li>case 1: Directly works on the c struct. You have to take care of for instance correct byte order yourself.</li>
<li>case 2: Using the utility functions for members. This method is the recommended one when setting members during the actual 'runtime' of MoonGen. It takes care of correct types and byte order while providing the same speed.</li>
<li>case 3 and 4: Using a table of named arguments to set multiple/all members of a/all header(s). This method is considerably slower than case 2. The advantage is you can set members to the values you specify and all other members to default values, fitting for the current packet type. This method is therefore recommended when prefilling mempools. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="documentation.html">MoonGen Manual</a></li>
    <li class="footer">Generated on Mon Aug 24 2015 21:48:26 for MoonGen by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
