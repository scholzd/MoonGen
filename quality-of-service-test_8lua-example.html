<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>MoonGen: quality-of-service-test.lua</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">MoonGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="download.html"><span>Download</span></a></li>
      <li><a href="documentation.html"><span>Documentation</span></a></li>
      <li><a href="files.html"><span>Filebrowser</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('quality-of-service-test_8lua-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">quality-of-service-test.lua</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">--- This script implements a simple QoS test by generating two flows and measuring their latencies.</div>
<div class="line">local mg        = require <span class="stringliteral">&quot;dpdk&quot;</span> -- TODO: rename dpdk module to <span class="stringliteral">&quot;moongen&quot;</span></div>
<div class="line">local memory    = require <span class="stringliteral">&quot;memory&quot;</span></div>
<div class="line">local device    = require <span class="stringliteral">&quot;device&quot;</span></div>
<div class="line">local ts        = require <span class="stringliteral">&quot;timestamping&quot;</span></div>
<div class="line">local filter    = require <span class="stringliteral">&quot;filter&quot;</span></div>
<div class="line">local stats     = require <span class="stringliteral">&quot;stats&quot;</span></div>
<div class="line">local hist      = require <span class="stringliteral">&quot;histogram&quot;</span></div>
<div class="line">local timer     = require <span class="stringliteral">&quot;timer&quot;</span></div>
<div class="line"></div>
<div class="line">local PKT_SIZE  = 124 -- without CRC</div>
<div class="line">local ETH_DST   = <span class="stringliteral">&quot;10:11:12:13:14:15&quot;</span> -- src mac is taken from the NIC</div>
<div class="line">local IP_SRC    = <span class="stringliteral">&quot;192.168.0.1&quot;</span></div>
<div class="line">local NUM_FLOWS = 256 -- src <a name="a0"></a><a class="code" href="ip4_8lua.html#a47df415387eb6f4fdd5752c3b5de89a7">ip</a> will be IP_SRC + random(0, NUM_FLOWS - 1)</div>
<div class="line">local IP_DST    = &quot;10.0.0.1&quot;</div>
<div class="line">local PORT_SRC  = 1234</div>
<div class="line">local PORT_FG   = 42</div>
<div class="line">local PORT_BG   = 43</div>
<div class="line"></div>
<div class="line">function master(txPort, rxPort, bgRate, fgRate)</div>
<div class="line">    if not txPort or not rxPort then</div>
<div class="line">        return print(&quot;usage: txPort rxPort [bgRate [fgRate]]&quot;)</div>
<div class="line">    end</div>
<div class="line">    fgRate = fgRate or 100</div>
<div class="line">    bgRate = bgRate or 1500</div>
<div class="line">    -- 3 tx queues: traffic, background traffic, and timestamped packets</div>
<div class="line">    -- 2 rx queues: traffic and timestamped packets</div>
<div class="line">    local txDev, rxDev</div>
<div class="line">    -- these two cases could actually be merged as re-configurations of ports are ignored</div>
<div class="line">    -- the dual-port case could just <a name="a1"></a><a class="code" href="device_8lua.html#a4070311b8fb2e41c9360cda2799f3817">config</a> the &#39;first&#39; device with 2/3 queues</div>
<div class="line">    -- however, this example scripts shows the explicit configuration instead of implicit magic</div>
<div class="line">    if txPort == rxPort then</div>
<div class="line">        -- sending and receiving from the same port</div>
<div class="line">        txDev = device.<a class="code" href="device_8lua.html#a4070311b8fb2e41c9360cda2799f3817">config</a>(txPort, 2, 3)</div>
<div class="line">        rxDev = txDev</div>
<div class="line">    else</div>
<div class="line">        -- two different ports, different configuration</div>
<div class="line">        txDev = device.<a class="code" href="device_8lua.html#a4070311b8fb2e41c9360cda2799f3817">config</a>(txPort, 1, 3)</div>
<div class="line">        rxDev = device.<a class="code" href="device_8lua.html#a4070311b8fb2e41c9360cda2799f3817">config</a>(rxPort, 2)</div>
<div class="line">    end</div>
<div class="line">    -- wait until the links are up</div>
<div class="line">    device.<a name="a2"></a><a class="code" href="device_8lua.html#af0be01549c4a122ac49100385183971d">waitForLinks</a>()</div>
<div class="line">    <a name="a3"></a><a class="code" href="utils_8lua.html#ae54683ab3fdfbeb0a0f010986338a73e">printf</a>(&quot;Sending %d MBit/s background traffic to UDP port %d&quot;, bgRate, PORT_BG)</div>
<div class="line">    <a class="code" href="utils_8lua.html#ae54683ab3fdfbeb0a0f010986338a73e">printf</a>(&quot;Sending %d MBit/s foreground traffic to UDP port %d&quot;, fgRate, PORT_FG)</div>
<div class="line">    -- setup rate limiters for CBR traffic</div>
<div class="line">    -- see l2-poisson.lua for an example with different traffic patterns</div>
<div class="line">    txDev:getTxQueue(0):<a name="a4"></a><a class="code" href="device_8lua.html#a39e83bb8d7f43bbbd237d87aefbb5c72">setRate</a>(bgRate)</div>
<div class="line">    txDev:getTxQueue(1):<a class="code" href="device_8lua.html#a39e83bb8d7f43bbbd237d87aefbb5c72">setRate</a>(fgRate)</div>
<div class="line">    -- background traffic</div>
<div class="line">    if bgRate &gt; 0 then</div>
<div class="line">        mg.<a name="a5"></a><a class="code" href="dpdk_8lua.html#a527169b72422c8d7e1e5d4504164ad39">launchLua</a>(&quot;loadSlave&quot;, txDev:getTxQueue(0), PORT_BG)</div>
<div class="line">    end</div>
<div class="line">    -- high priority traffic (different UDP port)</div>
<div class="line">    if fgRate &gt; 0 then</div>
<div class="line">        mg.<a class="code" href="dpdk_8lua.html#a527169b72422c8d7e1e5d4504164ad39">launchLua</a>(&quot;loadSlave&quot;, txDev:getTxQueue(1), PORT_FG)</div>
<div class="line">    end</div>
<div class="line">    -- count the incoming packets</div>
<div class="line">    mg.<a class="code" href="dpdk_8lua.html#a527169b72422c8d7e1e5d4504164ad39">launchLua</a>(&quot;counterSlave&quot;, rxDev:getRxQueue(0))</div>
<div class="line">    -- measure latency from a second queue</div>
<div class="line">    timerSlave(txDev:getTxQueue(2), rxDev:getRxQueue(1), PORT_BG, PORT_FG, fgRate / (fgRate + bgRate))</div>
<div class="line">    -- wait until all tasks are finished</div>
<div class="line">    mg.<a name="a6"></a><a class="code" href="dpdk_8lua.html#ab81defaf645bb7af7841899472acef9e">waitForSlaves</a>()</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line">function loadSlave(queue, port)</div>
<div class="line">    mg.<a name="a7"></a><a class="code" href="dpdk_8lua.html#aa83fbc2e0d94b53aebaabc0021132b20">sleepMillis</a>(100) -- wait a few milliseconds to ensure that the rx thread is <a name="a8"></a><a class="code" href="dpdk_8lua.html#a9c3302b6465084549f626875f203ff39">running</a></div>
<div class="line">    -- TODO: implement barriers</div>
<div class="line">    local mem = memory.<a name="a9"></a><a class="code" href="memory_8lua.html#abcc77fc5fbe39024027817be38007e89">createMemPool</a>(function(buf)</div>
<div class="line">        buf:<a name="a10"></a><a class="code" href="udp_8lua.html#adaa53b02964eaa0ac8d46b96eceeabbe">getUdpPacket</a>():<a name="a11"></a><a class="code" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4">fill</a>{</div>
<div class="line">            pktLength = PKT_SIZE, -- <span class="keyword">this</span> sets all length headers fields in all used protocols</div>
<div class="line">            ethSrc = queue, -- <span class="keyword">get</span> the src mac from the device</div>
<div class="line">            ethDst = ETH_DST,</div>
<div class="line">            -- ipSrc will be <a name="a12"></a><a class="code" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e">set</a> later as it varies</div>
<div class="line">            ip4Dst = IP_DST,</div>
<div class="line">            udpSrc = PORT_SRC,</div>
<div class="line">            udpDst = port,</div>
<div class="line">            -- payload will be initialized to 0x00 as <span class="keyword">new</span> memory pools are initially empty</div>
<div class="line">        }</div>
<div class="line">    end)</div>
<div class="line">    -- TODO: fix per-queue stats counters to use the statistics registers here</div>
<div class="line">    local txCtr = stats:<a name="a13"></a><a class="code" href="stats_8lua.html#a584d912840cce27485bf5d4428ac4ecb">newManualTxCounter</a>(<span class="stringliteral">&quot;Port &quot;</span> .. port, <span class="stringliteral">&quot;plain&quot;</span>)</div>
<div class="line">    local baseIP = <a name="a14"></a><a class="code" href="utils_8lua.html#a70410fc00bc98caf32a7fffc9623ed02">parseIPAddress</a>(IP_SRC)</div>
<div class="line">    -- a buf array is essentially a very thing wrapper around a rte_mbuf*[], i.e. an array of pointers to packet buffers</div>
<div class="line">    local bufs = mem:<a name="a15"></a><a class="code" href="memory_8lua.html#ae14f89bf497b843f729b4f816833d12d">bufArray</a>()</div>
<div class="line">    while mg.<a class="code" href="dpdk_8lua.html#a9c3302b6465084549f626875f203ff39">running</a>() do</div>
<div class="line">        -- allocate buffers from the mem pool and store them in this array</div>
<div class="line">        bufs:alloc(PKT_SIZE)</div>
<div class="line">        for _, buf in ipairs(bufs) do</div>
<div class="line">            -- modify some fields here</div>
<div class="line">            local <a name="a16"></a><a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a> = buf:<a class="code" href="udp_8lua.html#adaa53b02964eaa0ac8d46b96eceeabbe">getUdpPacket</a>()</div>
<div class="line">            -- select a randomized source IP address</div>
<div class="line">            -- you can also use a wrapping counter instead of random</div>
<div class="line">            <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a>.ip4.src:<a class="code" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e">set</a>(baseIP + math.random(NUM_FLOWS) - 1)</div>
<div class="line">            -- you can modify other fields here (e.g. different source ports or destination addresses)</div>
<div class="line">        end</div>
<div class="line">        -- send packets</div>
<div class="line">        bufs:offloadUdpChecksums()</div>
<div class="line">        txCtr:updateWithSize(queue:send(bufs), PKT_SIZE)</div>
<div class="line">    end</div>
<div class="line">    txCtr:<a name="a17"></a><a class="code" href="stats_8lua.html#a600e597c890d380924cca5966a433341">finalize</a>()</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line">function counterSlave(queue)</div>
<div class="line">    -- the simplest way to count packets is by receiving them all</div>
<div class="line">    -- an alternative would be using flow director to filter packets by port and use the queue statistics</div>
<div class="line">    -- however, the current implementation is limited to filtering timestamp packets</div>
<div class="line">    -- (changing this wouldn&#39;t be too complicated, have a look at filter.lua if you want to implement this)</div>
<div class="line">    -- however, queue statistics are also not yet implemented and the DPDK abstraction is somewhat annoying</div>
<div class="line">    local bufs = memory.<a class="code" href="memory_8lua.html#ae14f89bf497b843f729b4f816833d12d">bufArray</a>()</div>
<div class="line">    local ctrs = {}</div>
<div class="line">    <span class="keywordflow">while</span> mg.running(100) <span class="keywordflow">do</span></div>
<div class="line">        local rx = queue:<a name="a18"></a><a class="code" href="device_8lua.html#a9f4b12f18a787a92276527a509f9dba4">recv</a>(bufs)</div>
<div class="line">        for i = 1, rx do</div>
<div class="line">            local buf = bufs[i]</div>
<div class="line">            local <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a> = buf:<a class="code" href="udp_8lua.html#adaa53b02964eaa0ac8d46b96eceeabbe">getUdpPacket</a>()</div>
<div class="line">            local port = <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a>.<a name="a19"></a><a class="code" href="udp_8lua.html#a605be069667aac4e9674572dee46d278">udp</a>:<a name="a20"></a><a class="code" href="tcp_8lua.html#a9ef0c137e13d03ea59027ce28e434b87">getDstPort</a>()</div>
<div class="line">            local ctr = ctrs[port]</div>
<div class="line">            if not ctr then</div>
<div class="line">                ctr = stats:<a name="a21"></a><a class="code" href="stats_8lua.html#ae9d4659ff699f958eb6eadc4663363b8">newPktRxCounter</a>(&quot;Port &quot; .. port, &quot;plain&quot;)</div>
<div class="line">                ctrs[port] = ctr</div>
<div class="line">            end</div>
<div class="line">            ctr:<a name="a22"></a><a class="code" href="stats_8lua.html#ab495a0b35053fa16f2ac9aaeedbf4051">countPacket</a>(buf)</div>
<div class="line">        end</div>
<div class="line">        -- update() on rxPktCounters must be called to print statistics periodically</div>
<div class="line">        -- this is not done in <a class="code" href="stats_8lua.html#ab495a0b35053fa16f2ac9aaeedbf4051">countPacket</a>() for performance reasons (needs to check timestamps)</div>
<div class="line">        for k, v in pairs(ctrs) do</div>
<div class="line">            v:update()</div>
<div class="line">        end</div>
<div class="line">        bufs:<a name="a23"></a><a class="code" href="memory_8lua.html#ab45e0285d4e972a6358f4548c1965a17">freeAll</a>()</div>
<div class="line">    end</div>
<div class="line">    for k, v in pairs(ctrs) do</div>
<div class="line">        v:<a class="code" href="stats_8lua.html#a600e597c890d380924cca5966a433341">finalize</a>()</div>
<div class="line">    end</div>
<div class="line">    -- TODO: check the queue&#39;s overflow counter to detect lost packets</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">-- TODO refactor this to use the <a name="a24"></a><a class="code" href="barrier_8lua.html#a24e198c210d92b2489e731362d31ba17">new</a> API</div>
<div class="line">function timerSlave(txQueue, rxQueue, bgPort, port, ratio)</div>
<div class="line">    local txDev = txQueue.dev</div>
<div class="line">    local rxDev = rxQueue.dev</div>
<div class="line">    rxDev:<a name="a25"></a><a class="code" href="filter_8lua.html#a65df41f392d8af485463a8615a509418">filterTimestamps</a>(rxQueue)</div>
<div class="line">    local timestamper = ts:newUdpTimestamper(txQueue, rxQueue)</div>
<div class="line">    local histBg, histFg = hist(), hist()</div>
<div class="line">    -- wait one second, otherwise we might start timestamping before the load is applied</div>
<div class="line">    mg.<a class="code" href="dpdk_8lua.html#aa83fbc2e0d94b53aebaabc0021132b20">sleepMillis</a>(1000)</div>
<div class="line">    local baseIP = <a class="code" href="utils_8lua.html#a70410fc00bc98caf32a7fffc9623ed02">parseIPAddress</a>(IP_SRC)</div>
<div class="line">    local rateLimit = timer:<a class="code" href="barrier_8lua.html#a24e198c210d92b2489e731362d31ba17">new</a>(0.001)</div>
<div class="line">    while mg.<a class="code" href="dpdk_8lua.html#a9c3302b6465084549f626875f203ff39">running</a>() do</div>
<div class="line">        local port = math.random() &lt;= ratio and port or bgPort</div>
<div class="line">        local lat = timestamper:measureLatency(PKT_SIZE, function(buf)</div>
<div class="line">            local <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a> = buf:<a class="code" href="udp_8lua.html#adaa53b02964eaa0ac8d46b96eceeabbe">getUdpPacket</a>()</div>
<div class="line">            <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a>:<a class="code" href="arp_8lua.html#aa4fec404844cc2c6cb2c0b83ad3040f4">fill</a>{</div>
<div class="line">                pktLength = PKT_SIZE, -- <span class="keyword">this</span> sets all length headers fields in all used protocols</div>
<div class="line">                ethSrc = txQueue, -- <span class="keyword">get</span> the src mac from the device</div>
<div class="line">                ethDst = ETH_DST,</div>
<div class="line">                -- ipSrc will be <a class="code" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e">set</a> later as it varies</div>
<div class="line">                ip4Dst = IP_DST,</div>
<div class="line">                udpSrc = PORT_SRC,</div>
<div class="line">                udpDst = port,</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="packet_8lua.html#af8027fe3e9f1acfedd960d3c9b8b6b51">pkt</a>.ip4.src:<a class="code" href="ethernet_8lua.html#a77e75ae36313b17315d8ced823089f9e">set</a>(baseIP + math.random(NUM_FLOWS) - 1)</div>
<div class="line">        end)</div>
<div class="line">        <span class="keywordflow">if</span> lat then</div>
<div class="line">            <span class="keywordflow">if</span> port == bgPort then</div>
<div class="line">                histBg:update(lat)</div>
<div class="line">            else</div>
<div class="line">                histFg:update(lat)</div>
<div class="line">            end</div>
<div class="line">        end</div>
<div class="line">        rateLimit:wait()</div>
<div class="line">        rateLimit:reset()</div>
<div class="line">    end</div>
<div class="line">    mg.<a class="code" href="dpdk_8lua.html#aa83fbc2e0d94b53aebaabc0021132b20">sleepMillis</a>(100) -- to prevent overlapping stdout</div>
<div class="line">    histBg:save(&quot;hist-background.csv&quot;)</div>
<div class="line">    histFg:save(&quot;hist-foreground.csv&quot;)</div>
<div class="line">    histBg:print(&quot;Background traffic&quot;)</div>
<div class="line">    histFg:print(&quot;Foreground traffic&quot;)</div>
<div class="line">end</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Aug 24 2015 21:48:26 for MoonGen by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
